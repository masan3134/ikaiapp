// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  MANAGER
  HR_SPECIALIST
}

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

model Organization {
  id     String  @id @default(uuid())
  name   String
  slug   String  @unique
  domain String?

  // Branding
  logo         String?
  primaryColor String? @default("#4F46E5")

  // Settings
  industry String?
  size     String?
  country  String? @default("TR")
  timezone String? @default("Europe/Istanbul")

  // Subscription
  plan          SubscriptionPlan @default(FREE)
  planStartedAt DateTime         @default(now())
  planExpiresAt DateTime?

  // Usage Tracking
  monthlyAnalysisCount Int @default(0)
  monthlyCvCount       Int @default(0)
  totalUsers           Int @default(1)

  // Limits (based on plan)
  maxAnalysisPerMonth Int @default(10)
  maxCvPerMonth       Int @default(50)
  maxUsers            Int @default(2)

  // Onboarding
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)

  // Status
  isActive    Boolean   @default(true)
  isTrial     Boolean   @default(true)
  trialEndsAt DateTime?

  // Relations
  users User[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
  @@index([plan])
  @@map("organizations")
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  password String
  role     Role   @default(USER)

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // User profile
  firstName String?
  lastName  String?
  avatar    String?
  position  String?

  // Onboarding
  isOnboarded Boolean @default(false)

  createdAt DateTime @default(now())

  // Relations
  jobPostings           JobPosting[]
  candidates            Candidate[]
  analyses              Analysis[]
  assessmentTests       AssessmentTest[]
  bulkUploadSessions    BulkUploadSession[]
  interviewsAsConductor Interview[]         @relation("InterviewConductor")
  interviewsAsCreator   Interview[]         @relation("InterviewCreator")

  // NEW Relations for Job Offer System
  offersCreated  JobOffer[]         @relation("OfferCreator")
  offersApproved JobOffer[]         @relation("OfferApprover")
  negotiations   OfferNegotiation[]
  attachments    OfferAttachment[]
  revisions      OfferRevision[]

  @@index([organizationId])
  @@map("users")
}

model JobPosting {
  id             String    @id @default(uuid())
  title          String
  department     String
  details        String    @db.Text
  notes          String?   @db.Text
  userId         String
  organizationId String
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  analyses        Analysis[]
  assessmentTests AssessmentTest[]
  jobOffers       JobOffer[]

  @@index([userId])
  @@index([organizationId])
  @@index([isDeleted])
  @@index([userId, isDeleted]) // Composite: most common query pattern
  @@index([organizationId, isDeleted]) // Multi-tenant filter
  @@index([createdAt(sort: Desc)]) // For recent postings
  @@map("job_postings")
}

model Candidate {
  id             String    @id @default(uuid())
  firstName      String
  lastName       String
  phone          String
  email          String
  address        String
  experience     String    @db.Text
  education      String    @db.Text
  generalComment String    @db.Text
  sourceFileName String
  fileUrl        String? // MinIO presigned URL for file access
  userId         String
  organizationId String
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysisResults AnalysisResult[]
  testSubmissions TestSubmission[]
  interviews      InterviewCandidate[] // Many-to-many through junction
  jobOffers       JobOffer[]

  @@index([userId])
  @@index([organizationId])
  @@index([email])
  @@index([isDeleted])
  @@index([userId, isDeleted]) // Composite: most common query pattern
  @@index([organizationId, isDeleted]) // Multi-tenant filter
  @@index([createdAt(sort: Desc)]) // For recent candidates
  @@map("candidates")
}

model Analysis {
  id             String    @id @default(uuid())
  jobPostingId   String
  userId         String
  organizationId String
  status         String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errorMessage   String?   @db.Text
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  version        Int       @default(1) // Version tracking for AI chat freshness
  updatedAt      DateTime  @default(now()) @updatedAt // Auto-update timestamp

  // Relations
  jobPosting      JobPosting       @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysisResults AnalysisResult[]

  @@index([userId])
  @@index([organizationId])
  @@index([jobPostingId])
  @@index([status])
  @@index([version]) // Index for version queries
  @@index([userId, status]) // Composite: dashboard filtering
  @@index([organizationId, status]) // Multi-tenant filter
  @@index([createdAt(sort: Desc)]) // For recent analyses
  @@map("analyses")
}

model AnalysisResult {
  id             String @id @default(uuid())
  analysisId     String
  candidateId    String
  organizationId String

  // V7.1: Scores (all 0-100, weighted final)
  experienceScore    Int? // Sub-score for experience (0-100)
  educationScore     Int? // Sub-score for education (0-100)
  technicalScore     Int? // Sub-score for technical skills (0-100)
  softSkillsScore    Int? // V7.1: Soft skills & leadership (0-100)
  extraScore         Int? // Sub-score for language/location/other (0-100)
  compatibilityScore Int // V7.1: Weighted final score (0-100)

  // V7.1: Dynamic weighting profile
  scoringProfile Json? // {experienceWeight, educationWeight, technicalWeight, softSkillsWeight, extraWeight, rationale}

  // V7.1: Summaries
  experienceSummary String? @db.Text // Detailed experience narrative in Turkish
  educationSummary  String? @db.Text // Detailed education narrative in Turkish
  careerTrajectory  String? @db.Text // Career growth pattern analysis in Turkish

  // V7.1: Comments (with evidence type labels)
  positiveComments Json // Array of strings with (kanıt_tipi: Doğrudan/Çıkarım)
  negativeComments Json // Array of strings with impact/mitigation

  // V7.1: Strategic summary
  strategicSummary Json? // {executiveSummary, keyStrengths[], keyRisks[], interviewQuestions[], finalRecommendation, hiringTimeline}

  // Legacy (backward compatibility)
  matchLabel String? // Auto-generated from compatibilityScore: "Uyum Düşük", "İyi Eşleşme", "Güçlü Eşleşme"

  createdAt DateTime @default(now())

  // Relations
  analysis   Analysis    @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  candidate  Candidate   @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  interviews Interview[]

  @@index([analysisId])
  @@index([candidateId])
  @@index([organizationId])
  @@index([compatibilityScore])
  @@index([analysisId, compatibilityScore]) // Composite: score filtering within analysis
  @@index([organizationId, compatibilityScore]) // Multi-tenant filter
  @@index([createdAt(sort: Desc)]) // For recent results
  @@map("analysis_results")
}

model AssessmentTest {
  id             String  @id @default(uuid())
  jobPostingId   String
  createdBy      String
  organizationId String
  token          String  @unique
  analysisId     String? // NEW: Analysis-based MASTER test strategy

  questions Json // [{ id, category, question, options: [], correctAnswer, explanation }]

  expiresAt   DateTime // 2 days from creation
  maxAttempts Int      @default(3)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  jobPosting  JobPosting       @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  submissions TestSubmission[]

  @@index([token])
  @@index([jobPostingId])
  @@index([createdBy])
  @@index([organizationId])
  @@index([expiresAt])
  @@index([analysisId]) // NEW: Index for analysis-based lookups
  @@index([analysisId, maxAttempts]) // NEW: Composite for MASTER test lookups
  @@index([organizationId, expiresAt]) // Multi-tenant filter
  @@map("assessment_tests")
}

model TestSubmission {
  id             String  @id @default(uuid())
  testId         String
  candidateId    String?
  candidateEmail String
  candidateName  String?

  answers      Json // [{ questionId, selectedOption }]
  score        Int // 0-100
  correctCount Int // 0-10

  attemptNumber Int // 1, 2, or 3
  startedAt     DateTime
  completedAt   DateTime @default(now())

  // Anti-cheat metadata (expanded tracking)
  metadata Json? // { tabSwitchCount, copyAttempts, screenshotAttempts, pasteAttempts, autoSubmit, tabSwitches: [{timestamp, duration}], violations: [] }

  // Relations
  test      AssessmentTest @relation(fields: [testId], references: [id], onDelete: Cascade)
  candidate Candidate?     @relation(fields: [candidateId], references: [id], onDelete: SetNull)

  @@index([testId])
  @@index([candidateEmail])
  @@index([candidateId])
  @@index([completedAt])
  @@index([testId, score(sort: Desc)]) // Composite: top scorers per test
  @@index([score(sort: Desc)]) // For global high score listing
  @@map("test_submissions")
}

// NEW FEATURE #8: Bulk CV Upload & Auto-Analysis
// Tracks bulk upload sessions and processing results
model BulkUploadSession {
  id              String   @id @default(uuid())
  userId          String
  organizationId  String
  totalFiles      Int
  processedFiles  Int      @default(0)
  successfulFiles Int      @default(0)
  failedFiles     Int      @default(0)
  status          String   @default("PROCESSING") // PROCESSING, COMPLETED, FAILED, CANCELLED
  results         Json? // Array of {filename, candidateId, status, error}
  autoAnalyze     Boolean  @default(false) // Whether to auto-trigger analysis
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([organizationId, status]) // Multi-tenant filter
  @@index([createdAt(sort: Desc)])
  @@map("bulk_upload_sessions")
}

// NEW FEATURE #3: AI Interview Scheduler
// Manages interview scheduling with AI-powered slot suggestions

// ============================================
// INTERVIEW MANAGEMENT SYSTEM (v2 - Wizard)
// ============================================

// Main Interview Table
model Interview {
  id             String @id @default(uuid())
  organizationId String

  // Interview Type & Details
  type     String // 'phone', 'online', 'in-person'
  date     DateTime
  time     String // HH:MM format
  duration Int      @default(60) // minutes

  // Location/Meeting Info
  location     String? // For in-person interviews
  meetLink     String? // Google Meet link for online
  meetEventId  String? // Google Calendar event ID
  meetingTitle String? // Custom meeting title

  // Interviewer
  interviewerId String
  interviewer   User   @relation("InterviewConductor", fields: [interviewerId], references: [id], onDelete: Cascade)

  // Notes & Template
  notes         String? @db.Text // Additional notes
  emailTemplate String? @db.Text // Email body sent to candidates
  emailSent     Boolean @default(false)

  // Status Tracking
  status String @default("scheduled") // scheduled, completed, cancelled, rescheduled, no_show

  // Candidates (Many-to-Many)
  candidates InterviewCandidate[]

  // Metadata
  createdBy        String
  creator          User            @relation("InterviewCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  AnalysisResult   AnalysisResult? @relation(fields: [analysisResultId], references: [id])
  analysisResultId String?

  @@index([date, time])
  @@index([status])
  @@index([interviewerId])
  @@index([organizationId])
  @@index([organizationId, status]) // Multi-tenant filter
  @@index([createdAt(sort: Desc)])
  @@map("interviews")
}

// Junction Table: Interview ↔ Candidate (Many-to-Many)
model InterviewCandidate {
  id String @id @default(uuid())

  // Relations
  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  // Candidate-specific data
  attended Boolean? // null = pending, true = attended, false = no-show
  feedback String?  @db.Text
  rating   Int? // 1-5 rating for this candidate
  notes    String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([interviewId, candidateId])
  @@index([interviewId])
  @@index([candidateId])
  @@map("interview_candidates")
}

// ============================================
// JOB OFFER SYSTEM (Features from Phases 1, 2, 3 and beyond)
// ============================================

enum OfferStatus {
  draft
  pending_approval
  approved
  sent
  accepted
  rejected
  expired
  cancelled
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum NegotiationStatus {
  pending
  accepted
  rejected
  superseded
}

// ============================================
// OFFER TEMPLATE CATEGORY (Feature #30)
// ============================================
model OfferTemplateCategory {
  id             String  @id @default(uuid())
  organizationId String
  name           String // "Yazılım", "Satış", "Yönetim"
  description    String? @db.Text
  color          String? // Hex color for UI
  icon           String? // Icon name
  order          Int     @default(0) // Display order

  templates OfferTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([organizationId])
  @@index([organizationId, order]) // Multi-tenant filter
  @@map("offer_template_categories")
}

// ============================================
// OFFER TEMPLATE (Features #7, #8, #13, #14)
// ============================================
model OfferTemplate {
  id             String  @id @default(uuid())
  organizationId String
  name           String // "Senior Software Engineer Offer"
  description    String? @db.Text
  categoryId     String?

  // Position defaults
  position   String
  department String

  // Salary range
  salaryMin Int
  salaryMax Int
  currency  String @default("TRY")

  // Benefits (JSON array)
  benefits Json // [{type: "insurance", amount: 0}, {type: "meal", amount: 1000}]

  // Work details
  workType String @default("office") // office, hybrid, remote

  // Terms and conditions
  terms String @db.Text

  // Email template
  emailSubject String
  emailBody    String @db.Text

  // Relations
  category OfferTemplateCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  offers   JobOffer[]

  // Metadata
  isActive   Boolean @default(true)
  usageCount Int     @default(0) // Track how many times used

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([organizationId])
  @@index([isActive])
  @@index([organizationId, isActive]) // Multi-tenant filter
  @@index([usageCount(sort: Desc)])
  @@map("offer_templates")
}

// ============================================
// JOB OFFER (Features #1-6, #9-12, #15)
// ============================================
model JobOffer {
  id             String @id @default(uuid())
  organizationId String

  // Relations
  candidateId  String
  jobPostingId String?
  templateId   String?
  createdBy    String

  // Offer Details (Feature #1)
  position   String
  department String
  salary     Int
  currency   String   @default("TRY")
  startDate  DateTime
  workType   String // office, hybrid, remote

  // Benefits (JSON object)
  benefits Json // {insurance: true, meal: 1000, transportation: true, gym: false}

  // Terms
  terms String @db.Text

  // Custom fields
  customFields    Json? // Flexible additional fields
  rejectionReason String? @db.Text // Why the candidate rejected the offer

  // Status & Tracking (Feature #4)
  status OfferStatus @default(draft)

  // Timestamps
  sentAt      DateTime?
  respondedAt DateTime?
  acceptedAt  DateTime? // When candidate accepted
  rejectedAt  DateTime? // When candidate rejected
  expiresAt   DateTime // Feature #12: 7 days validity

  // Acceptance System (Feature #9)
  acceptanceToken String  @unique @default(uuid())
  acceptanceUrl   String? // Full URL to acceptance page

  // Approval Flow (Feature #11)
  approvalStatus ApprovalStatus @default(pending)
  approvalNotes  String?        @db.Text
  approvedBy     String?
  approvedAt     DateTime?

  // Notifications (Feature #10)
  emailSent   Boolean   @default(false)
  emailSentAt DateTime?

  // Analytics tracking
  viewCount    Int       @default(0)
  lastViewedAt DateTime?

  // Relations
  candidate  Candidate      @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  jobPosting JobPosting?    @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  template   OfferTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  creator    User           @relation("OfferCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  approver   User?          @relation("OfferApprover", fields: [approvedBy], references: [id], onDelete: SetNull)

  // Sub-relations (Features #21, #23, #29)
  negotiations OfferNegotiation[]
  attachments  OfferAttachment[]
  revisions    OfferRevision[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([candidateId])
  @@index([jobPostingId])
  @@index([templateId])
  @@index([createdBy])
  @@index([organizationId])
  @@index([status])
  @@index([approvalStatus])
  @@index([acceptanceToken])
  @@index([expiresAt])
  @@index([sentAt])
  @@index([organizationId, status]) // Multi-tenant filter
  @@index([createdAt(sort: Desc)])
  @@map("job_offers")
}

// ============================================
// OFFER NEGOTIATION (Feature #21)
// ============================================
model OfferNegotiation {
  id      String @id @default(uuid())
  offerId String

  // Who is negotiating
  initiatedBy String // "candidate" or "company"

  // Counter offer details
  counterSalary   Int?
  counterBenefits Json? // Modified benefits
  message         String @db.Text

  // Response
  response    String?           @db.Text
  status      NegotiationStatus @default(pending)
  respondedAt DateTime?
  respondedBy String?

  // Relations
  offer     JobOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  responder User?    @relation(fields: [respondedBy], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([offerId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("offer_negotiations")
}

// ============================================
// OFFER ATTACHMENT (Feature #23)
// ============================================
model OfferAttachment {
  id      String @id @default(uuid())
  offerId String

  // File details
  filename     String
  originalName String
  mimeType     String
  size         Int // bytes

  // Storage
  fileUrl String // MinIO URL

  // Metadata
  description String? @db.Text
  uploadedBy  String

  // Relations
  offer    JobOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  uploader User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([offerId])
  @@map("offer_attachments")
}

// ============================================
// OFFER REVISION (Feature #29)
// ============================================
model OfferRevision {
  id      String @id @default(uuid())
  offerId String

  // Version info
  version    Int // 1, 2, 3...
  changeType String // created, updated, approved, sent

  // Snapshot of offer data at this version
  snapshot Json // Full offer object

  // What changed
  changes     Json? // Diff of changes {field: {old, new}}
  changeNotes String? @db.Text

  // Who made the change (nullable for public candidate actions)
  changedBy String?

  // Relations
  offer   JobOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  changer User?    @relation(fields: [changedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([offerId, version])
  @@index([offerId])
  @@index([createdAt(sort: Desc)])
  @@map("offer_revisions")
}
