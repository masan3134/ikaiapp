{
  "phase": "Phase 2.1 - Remaining Backend Routes Protection (FIX)",
  "duration": "1 hour",
  "priority": "CRITICAL",
  "dependencies": ["Phase 2 - 17 routes protected, 12 remaining"],
  "description": "Fix Phase 2 by protecting remaining 12 backend route files that were missed",

  "mcpRequirements": {
    "required": ["filesystem"],
    "optional": ["git", "sequentialthinking"],
    "usage": {
      "filesystem": "Read route files, add authorize middleware imports and usage",
      "git": "Commit after completion",
      "sequentialthinking": "Analyze which routes need protection"
    },
    "verification": "Check all 29 route files have authorize middleware (except 3 public)"
  },

  "toolUsageGuide": {
    "forAllTasks": {
      "step1": "Use Read tool to read route file",
      "step2": "Use Edit tool to add authorize middleware imports",
      "step3": "Use Edit tool to add authorize() to routes",
      "step4": "Verify no syntax errors"
    },
    "forTask_2.1.13_verification": {
      "step1": "Run bash grep commands",
      "step2": "Copy RAW outputs to MD file",
      "step3": "Count: should be 26 protected (29 total - 3 public)"
    }
  },

  "tasks": [
    {
      "id": "2.1.1",
      "title": "Protect Attachment Routes",
      "file": "backend/src/routes/attachmentRoutes.js",
      "priority": "HIGH",
      "estimatedTime": "5 minutes",
      "description": "Add HR_MANAGERS protection to attachment upload/download routes",
      "allowedRoles": ["HR_SPECIALIST", "MANAGER", "ADMIN", "SUPER_ADMIN"],
      "instructions": [
        "1. Read attachmentRoutes.js",
        "2. Import authorize and ROLE_GROUPS",
        "3. Create middleware: const hrManagers = [authenticateToken, enforceOrganizationIsolation, authorize(ROLE_GROUPS.HR_MANAGERS)]",
        "4. Apply to all routes (likely POST, GET, DELETE)"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLE_GROUPS } = require('../constants/roles');\n\nconst hrManagers = [authenticateToken, enforceOrganizationIsolation, authorize(ROLE_GROUPS.HR_MANAGERS)];\n\n// Apply to routes:\nrouter.post('/', ...hrManagers, uploadAttachment);\nrouter.get('/:id', ...hrManagers, getAttachment);\nrouter.delete('/:id', ...hrManagers, deleteAttachment);"
    },
    {
      "id": "2.1.2",
      "title": "Skip Auth Routes (PUBLIC)",
      "file": "backend/src/routes/authRoutes.js",
      "priority": "HIGH",
      "estimatedTime": "2 minutes",
      "description": "Verify authRoutes.js remains PUBLIC (no authorization needed)",
      "allowedRoles": ["PUBLIC"],
      "instructions": [
        "1. Read authRoutes.js",
        "2. Confirm routes are login, register, forgot-password (public)",
        "3. DO NOT add authorize middleware",
        "4. Mark as verified"
      ],
      "codePattern": "// NO CHANGES - These routes must remain public:\n// POST /login\n// POST /register\n// POST /forgot-password\n// POST /reset-password"
    },
    {
      "id": "2.1.3",
      "title": "Protect Cache Routes",
      "file": "backend/src/routes/cacheRoutes.js",
      "priority": "MEDIUM",
      "estimatedTime": "5 minutes",
      "description": "Add ADMIN+ protection to cache management routes",
      "allowedRoles": ["ADMIN", "SUPER_ADMIN"],
      "instructions": [
        "1. Read cacheRoutes.js",
        "2. Import authorize and ROLES",
        "3. Create adminOnly middleware",
        "4. Apply to all routes (GET /stats, POST /clear, etc.)"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLES } = require('../constants/roles');\n\nconst adminOnly = [authenticateToken, enforceOrganizationIsolation, authorize([ROLES.ADMIN, ROLES.SUPER_ADMIN])];\n\nrouter.get('/stats', ...adminOnly, getCacheStats);\nrouter.post('/clear', ...adminOnly, clearCache);"
    },
    {
      "id": "2.1.4",
      "title": "Protect Comprehensive Dashboard Routes",
      "file": "backend/src/routes/comprehensiveDashboardRoutes.js",
      "priority": "HIGH",
      "estimatedTime": "5 minutes",
      "description": "Add HR_MANAGERS protection to dashboard routes",
      "allowedRoles": ["HR_SPECIALIST", "MANAGER", "ADMIN", "SUPER_ADMIN"],
      "instructions": [
        "1. Read comprehensiveDashboardRoutes.js",
        "2. Import authorize and ROLE_GROUPS",
        "3. Add HR_MANAGERS middleware",
        "4. Apply to all dashboard data routes"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLE_GROUPS } = require('../constants/roles');\n\nconst hrManagers = [authenticateToken, enforceOrganizationIsolation, authorize(ROLE_GROUPS.HR_MANAGERS)];"
    },
    {
      "id": "2.1.5",
      "title": "Protect Metrics Routes",
      "file": "backend/src/routes/metricsRoutes.js",
      "priority": "MEDIUM",
      "estimatedTime": "5 minutes",
      "description": "Add ADMIN+ protection to system metrics routes",
      "allowedRoles": ["ADMIN", "SUPER_ADMIN"],
      "instructions": [
        "1. Read metricsRoutes.js",
        "2. Import authorize and ROLES",
        "3. Create adminOnly middleware",
        "4. Protect all metrics endpoints"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLES } = require('../constants/roles');\n\nconst adminOnly = [authenticateToken, enforceOrganizationIsolation, authorize([ROLES.ADMIN, ROLES.SUPER_ADMIN])];"
    },
    {
      "id": "2.1.6",
      "title": "Protect Milvus Sync Routes",
      "file": "backend/src/routes/milvusSyncRoutes.js",
      "priority": "MEDIUM",
      "estimatedTime": "5 minutes",
      "description": "Add ADMIN+ protection to Milvus vector DB sync routes",
      "allowedRoles": ["ADMIN", "SUPER_ADMIN"],
      "instructions": [
        "1. Read milvusSyncRoutes.js",
        "2. Import authorize and ROLES",
        "3. Create adminOnly middleware",
        "4. Protect sync, reindex endpoints"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLES } = require('../constants/roles');\n\nconst adminOnly = [authenticateToken, enforceOrganizationIsolation, authorize([ROLES.ADMIN, ROLES.SUPER_ADMIN])];"
    },
    {
      "id": "2.1.7",
      "title": "Protect Negotiation Routes",
      "file": "backend/src/routes/negotiationRoutes.js",
      "priority": "HIGH",
      "estimatedTime": "5 minutes",
      "description": "Add HR_MANAGERS protection to offer negotiation routes",
      "allowedRoles": ["HR_SPECIALIST", "MANAGER", "ADMIN", "SUPER_ADMIN"],
      "instructions": [
        "1. Read negotiationRoutes.js",
        "2. Import authorize and ROLE_GROUPS",
        "3. Add HR_MANAGERS middleware",
        "4. Apply to all negotiation endpoints"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLE_GROUPS } = require('../constants/roles');\n\nconst hrManagers = [authenticateToken, enforceOrganizationIsolation, authorize(ROLE_GROUPS.HR_MANAGERS)];"
    },
    {
      "id": "2.1.8",
      "title": "Skip Onboarding Routes (ALL AUTHENTICATED)",
      "file": "backend/src/routes/onboardingRoutes.js",
      "priority": "MEDIUM",
      "estimatedTime": "3 minutes",
      "description": "Verify onboarding routes allow all authenticated users (no role restriction)",
      "allowedRoles": ["ALL_AUTHENTICATED"],
      "instructions": [
        "1. Read onboardingRoutes.js",
        "2. Verify routes only have authenticateToken (no authorize)",
        "3. These should be accessible to all new users during setup",
        "4. Mark as verified"
      ],
      "codePattern": "// Keep as is - only authenticateToken:\nrouter.post('/complete', authenticateToken, completeOnboarding);\nrouter.get('/status', authenticateToken, getOnboardingStatus);\n// NO authorize middleware needed"
    },
    {
      "id": "2.1.9",
      "title": "Skip Public Offer Routes (PUBLIC)",
      "file": "backend/src/routes/publicOfferRoutes.js",
      "priority": "HIGH",
      "estimatedTime": "2 minutes",
      "description": "Verify public offer routes remain PUBLIC (candidate access via token)",
      "allowedRoles": ["PUBLIC"],
      "instructions": [
        "1. Read publicOfferRoutes.js",
        "2. Confirm routes use token-based access (no auth required)",
        "3. DO NOT add authorize middleware",
        "4. These allow candidates to view offers without login"
      ],
      "codePattern": "// NO CHANGES - Public offer access:\n// GET /public/:token (no auth)\n// POST /public/:token/respond (no auth)"
    },
    {
      "id": "2.1.10",
      "title": "Protect Revision Routes",
      "file": "backend/src/routes/revisionRoutes.js",
      "priority": "HIGH",
      "estimatedTime": "5 minutes",
      "description": "Add HR_MANAGERS protection to offer revision routes",
      "allowedRoles": ["HR_SPECIALIST", "MANAGER", "ADMIN", "SUPER_ADMIN"],
      "instructions": [
        "1. Read revisionRoutes.js",
        "2. Import authorize and ROLE_GROUPS",
        "3. Add HR_MANAGERS middleware",
        "4. Apply to all revision tracking endpoints"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLE_GROUPS } = require('../constants/roles');\n\nconst hrManagers = [authenticateToken, enforceOrganizationIsolation, authorize(ROLE_GROUPS.HR_MANAGERS)];"
    },
    {
      "id": "2.1.11",
      "title": "Protect Smart Search Routes",
      "file": "backend/src/routes/smartSearchRoutes.js",
      "priority": "HIGH",
      "estimatedTime": "5 minutes",
      "description": "Add HR_MANAGERS protection to smart search routes",
      "allowedRoles": ["HR_SPECIALIST", "MANAGER", "ADMIN", "SUPER_ADMIN"],
      "instructions": [
        "1. Read smartSearchRoutes.js",
        "2. Import authorize and ROLE_GROUPS",
        "3. Add HR_MANAGERS middleware",
        "4. Apply to all search endpoints"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLE_GROUPS } = require('../constants/roles');\n\nconst hrManagers = [authenticateToken, enforceOrganizationIsolation, authorize(ROLE_GROUPS.HR_MANAGERS)];"
    },
    {
      "id": "2.1.12",
      "title": "Protect User Routes (MIXED)",
      "file": "backend/src/routes/userRoutes.js",
      "priority": "HIGH",
      "estimatedTime": "8 minutes",
      "description": "Add mixed protection to user routes (some all auth, some ADMIN only)",
      "allowedRoles": {
        "profileRoutes": "ALL_AUTHENTICATED",
        "adminRoutes": ["ADMIN", "SUPER_ADMIN"]
      },
      "instructions": [
        "1. Read userRoutes.js",
        "2. Import authorize and ROLES",
        "3. Identify routes:",
        "   - GET /me, PUT /me, PATCH /password â†’ All authenticated",
        "   - GET /, POST /, DELETE /:id, PATCH /:id/role â†’ ADMIN only",
        "4. Apply appropriate middleware to each"
      ],
      "codePattern": "const { authorize } = require('../middleware/authorize');\nconst { ROLES } = require('../constants/roles');\n\n// Profile routes - all authenticated users\nrouter.get('/me', authenticateToken, getUserProfile);\nrouter.put('/me', authenticateToken, updateProfile);\nrouter.patch('/password', authenticateToken, changePassword);\n\n// Admin routes - ADMIN+ only\nconst adminOnly = [authenticateToken, enforceOrganizationIsolation, authorize([ROLES.ADMIN, ROLES.SUPER_ADMIN])];\nrouter.get('/', ...adminOnly, getAllUsers);\nrouter.post('/', ...adminOnly, createUser);\nrouter.delete('/:id', ...adminOnly, deleteUser);\nrouter.patch('/:id/role', ...adminOnly, updateUserRole);"
    },
    {
      "id": "2.1.13",
      "title": "Generate Final Verification Report",
      "priority": "CRITICAL",
      "estimatedTime": "10 minutes",
      "description": "Create comprehensive MD report with RAW verification data",
      "dependencies": ["2.1.12"],
      "outputFile": "docs/reports/phase2-complete-verification.md",
      "instructions": [
        "1. Run all verification commands below",
        "2. Copy RAW OUTPUT to MD file",
        "3. DO NOT interpret - paste exact terminal output",
        "4. Let reviewer verify 26/29 files protected (3 public excluded)"
      ],
      "reportTemplate": "# Phase 2 Complete - Backend Route Protection Verification\n\nDate: [CURRENT_DATE]\nExecutor: [YOUR_NAME]\n\n## 1. Total Route Files\n\n```bash\n$ ls backend/src/routes/*.js | wc -l\n```\n\n**Output:**\n```\n[PASTE_EXACT_OUTPUT]\n```\n\n**Expected:** 29\n\n---\n\n## 2. Protected Route Files Count\n\n```bash\n$ grep -l \"authorize\" backend/src/routes/*.js | wc -l\n```\n\n**Output:**\n```\n[PASTE_EXACT_OUTPUT]\n```\n\n**Expected:** 26 (29 total - 3 public)\n\n---\n\n## 3. List of Protected Files\n\n```bash\n$ grep -l \"authorize\" backend/src/routes/*.js\n```\n\n**Output:**\n```\n[PASTE_EXACT_OUTPUT]\n```\n\n---\n\n## 4. Unprotected Files (Should be 3 public)\n\n```bash\n$ comm -23 <(ls backend/src/routes/*.js | sort) <(grep -l \"authorize\" backend/src/routes/*.js | sort)\n```\n\n**Output:**\n```\n[PASTE_EXACT_OUTPUT]\n```\n\n**Expected Public Routes:**\n- authRoutes.js (login, register)\n- publicOfferRoutes.js (candidate offer access)\n- onboardingRoutes.js (all authenticated, no role check)\n\n---\n\n## 5. Authorize Usage Count by File\n\n```bash\n$ grep -c \"authorize\" backend/src/routes/*.js | grep -v \":0$\"\n```\n\n**Output:**\n```\n[PASTE_EXACT_OUTPUT]\n```\n\n---\n\n## 6. Backend Health Check\n\n```bash\n$ docker ps --filter \"name=ikai-backend\" --format \"{{.Status}}\"\n```\n\n**Output:**\n```\n[PASTE_EXACT_OUTPUT]\n```\n\n**Expected:** Up X minutes (healthy)\n\n---\n\n## 7. Sample Protected Routes\n\n### HR_MANAGERS Routes (should have ROLE_GROUPS.HR_MANAGERS)\n\n```bash\n$ grep -A 2 \"ROLE_GROUPS.HR_MANAGERS\" backend/src/routes/attachmentRoutes.js backend/src/routes/negotiationRoutes.js | head -10\n```\n\n**Output:**\n```\n[PASTE_EXACT_OUTPUT]\n```\n\n### ADMIN Routes (should have ROLES.ADMIN, ROLES.SUPER_ADMIN)\n\n```bash\n$ grep -A 2 \"ADMIN.*SUPER_ADMIN\" backend/src/routes/cacheRoutes.js backend/src/routes/metricsRoutes.js | head -10\n```\n\n**Output:**\n```\n[PASTE_EXACT_OUTPUT]\n```\n\n---\n\n## Summary\n\n**Total Route Files:** [NUMBER_FROM_SECTION_1]\n**Protected Files:** [NUMBER_FROM_SECTION_2]\n**Unprotected Files:** [COUNT_FROM_SECTION_4]\n**Public Routes (Expected):** authRoutes.js, publicOfferRoutes.js, onboardingRoutes.js\n**Backend Status:** [FROM_SECTION_6]\n\n**Status:** [COMPLETE/INCOMPLETE]\n\n---\n\n**Note to Reviewer:** \n- Expected: 26 protected + 3 public = 29 total\n- Verify unprotected files are only the 3 public routes\n- Check sample routes have correct role assignments\n",
      "verificationCommands": {
        "step1_total": "ls backend/src/routes/*.js | wc -l",
        "step2_protected": "grep -l \"authorize\" backend/src/routes/*.js | wc -l",
        "step3_list": "grep -l \"authorize\" backend/src/routes/*.js",
        "step4_unprotected": "comm -23 <(ls backend/src/routes/*.js | sort) <(grep -l \"authorize\" backend/src/routes/*.js | sort)",
        "step5_counts": "grep -c \"authorize\" backend/src/routes/*.js | grep -v \":0$\"",
        "step6_health": "docker ps --filter \"name=ikai-backend\" --format \"{{.Status}}\"",
        "step7a_hr": "grep -A 2 \"ROLE_GROUPS.HR_MANAGERS\" backend/src/routes/attachmentRoutes.js backend/src/routes/negotiationRoutes.js 2>/dev/null | head -10",
        "step7b_admin": "grep -A 2 \"ADMIN.*SUPER_ADMIN\" backend/src/routes/cacheRoutes.js backend/src/routes/metricsRoutes.js 2>/dev/null | head -10"
      }
    }
  ],

  "routeBreakdown": {
    "HR_MANAGERS": [
      "attachmentRoutes.js",
      "comprehensiveDashboardRoutes.js",
      "negotiationRoutes.js",
      "revisionRoutes.js",
      "smartSearchRoutes.js"
    ],
    "ADMIN_ONLY": [
      "cacheRoutes.js",
      "metricsRoutes.js",
      "milvusSyncRoutes.js",
      "userRoutes.js (admin endpoints)"
    ],
    "ALL_AUTHENTICATED": [
      "onboardingRoutes.js (no role check)",
      "userRoutes.js (profile endpoints)"
    ],
    "PUBLIC": [
      "authRoutes.js (login, register)",
      "publicOfferRoutes.js (candidate access)"
    ]
  },

  "verification": {
    "expectedProtected": 26,
    "expectedPublic": 3,
    "totalFiles": 29,
    "checks": [
      "âœ… 26 files have authorize middleware",
      "âœ… 3 public routes remain unprotected (correct)",
      "âœ… HR_MANAGERS applied to attachment, negotiation, revision, smart search",
      "âœ… ADMIN+ applied to cache, metrics, milvus",
      "âœ… User routes have mixed protection (profile vs admin)",
      "âœ… Backend starts without errors",
      "âœ… All imports resolved correctly"
    ]
  },

  "completionMessage": "ðŸŽ‰ Phase 2 COMPLETE (Fixed)!\n\nâœ… 26 route files protected\nâœ… 3 public routes (auth, public-offer, onboarding)\nâœ… 5 role levels enforced\nâœ… Backend operational\n\nNext: Phase 3 - Frontend Pages"
}
